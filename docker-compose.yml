
services:
  mysql:
    image: mysql:5.7
    container_name: mysql_control
    environment:
      - MYSQL_ROOT_PASSWORD=control_root_password
      - MYSQL_DATABASE=control_acceso
      - MYSQL_USER=control_user
      - MYSQL_PASSWORD=control_password
    ports:
      - "3307:3306"
    volumes:
      - mysql_data_new:/var/lib/mysql
      - ./backend/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password --sql-mode="NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION" --bind-address=0.0.0.0
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  mqtt:
    image: eclipse-mosquitto:2.0.18
    container_name: mqtt_server
    ports:
      - "1884:1883"  # MQTT
      - "9002:9001"  # Websocket
    volumes:
      - ./backend/mosquitto/config:/mosquitto/config
      - ./backend/mosquitto/data:/mosquitto/data
      - ./backend/mosquitto/log:/mosquitto/log
    environment:
      - MQTT_ALLOW_ANONYMOUS=true
      - MQTT_LISTENER=1883
      - MQTT_LISTENER_WS=9001
    restart: always

  backend:
    build: ./backend
    container_name: control_backend
    ports:
      - "8090:8090"
    depends_on:
      - mysql
      - mqtt
    environment:
      - DATABASE_HOST=mysql
      - DATABASE_USER=control_user
      - DATABASE_PASSWORD=control_password
      - DATABASE_NAME=control_acceso
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - JWT_EXPIRATION_MINUTES=60
    restart: always

  apache:
    image: httpd:2.4
    container_name: apache_server
    ports:
      - "8080:80"
    volumes:
      - ./backend/www:/usr/local/apache2/htdocs/
      - ./backend/apache-conf/extra:/usr/local/apache2/conf/extra
    depends_on:
      - backend
    restart: always

volumes:
  mysql_data_new:
  mosquitto_config:
